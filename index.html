<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>3DLab 工时→打印额度 动态计算器</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b1020;--card:#121830;--muted:#98a2b3;--fg:#e6e9f2;--acc:#6ea8fe;--acc2:#8ef6d2;--warn:#ffd166;
      --ring:#2a345e;--ring-acc:#3d64b3;--surface:#0f1530;--surface-2:#0c1128
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#1b2347 0%,#0b1020 40%,#0b1020 100%);color:var(--fg);font-family:"Noto Sans SC","Microsoft YaHei",-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB",sans-serif;line-height:1.6;min-height:100%;display:flex;flex-direction:column;padding-bottom:max(16px, env(safe-area-inset-bottom))}
    body::before{content:"";position:fixed;inset:0;background:
      radial-gradient(800px 400px at 90% -20%,rgba(110,168,254,.08),transparent 60%),
      radial-gradient(600px 400px at -10% 120%,rgba(142,246,210,.06),transparent 60%);
      pointer-events:none;z-index:-1;filter:blur(0.5px)
    }
    .container{max-width:1080px;margin:24px auto;padding:16px;display:flex;flex-direction:column;flex:1;min-height:0}
    .title{font-weight:800;font-size:28px;letter-spacing:.3px;display:flex;gap:12px;align-items:center}
    .subtitle{color:var(--muted);margin:6px 0 18px}
    .card{background:linear-gradient(180deg,#151c37,#101631);border:1px solid #263159;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.35);padding:18px;transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 14px 40px rgba(0,0,0,.45);border-color:#2e3a6b}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="number"],input[type="text"]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--ring);background:linear-gradient(180deg,var(--surface),var(--surface-2));color:var(--fg);outline:none;transition:border-color .2s ease, box-shadow .2s ease, background .2s ease}
    input:hover{border-color:#334078}
    input:focus{border-color:var(--acc);box-shadow:0 0 0 4px rgba(110,168,254,.18)}
    ::placeholder{color:#6b7280}
    .kpi{display:flex;align-items:baseline;gap:8px;flex-wrap:nowrap}
    .kpi .value{font-weight:800;font-size:32px;color:var(--fg);white-space:nowrap}
    .kpi .unit{color:var(--muted);white-space:nowrap}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--acc),#8aa8ff);color:#0a1022;box-shadow:0 6px 16px rgba(64,87,167,.35);transition:transform .12s ease, box-shadow .12s ease, filter .12s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(64,87,167,.5)}
    .btn:active{transform:translateY(0)}
    .btn.secondary{background:transparent;color:var(--fg);border:1px solid #2a345e}
    .btn.secondary:hover{border-color:#3a4a86;background:rgba(58,74,134,.12)}
    .btn.warn{background:linear-gradient(90deg,var(--warn),#ffc857);color:#382800}
    .btn.warn:hover{filter:brightness(1.02)}
    .row{display:flex;gap:10px;align-items:center}
    .flex-spacer{height:16px}
    .grow{flex:1;min-height:0}
    .table-wrap{height:100%;overflow:auto;border-radius:12px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#141b35,#111733);backdrop-filter:saturate(1.1) blur(2px);font-size:12px;color:var(--muted);text-align:left;padding:8px 12px;border-bottom:1px solid #263159;z-index:1}
    tbody td{background:#0f1530;border:1px solid #263159;padding:12px;border-left:none;border-right:none;transition:background .15s ease,border-color .15s ease}
    tbody tr{border-radius:12px;overflow:hidden}
    tbody td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px;border-left:1px solid #263159}
    tbody td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px;border-right:1px solid #263159}
    tbody tr:hover td{background:#111943;border-color:#2b3a6a}
    tbody tr:nth-child(odd) td{background:#0e1536}
    .note{color:var(--muted);font-size:12px;line-height:1.5}
    .pill{display:inline-block;background:linear-gradient(90deg,rgba(142,246,210,.14),rgba(110,168,254,.12));color:var(--acc2);border:1px solid rgba(142,246,210,.35);padding:6px 10px;border-radius:999px;font-size:12px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    tbody tr{animation:fadeIn .22s ease both}

    /* 响应式 */
    @media (max-width: 900px){
      .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 600px){
      .container{padding:12px;margin:12px auto}
      .grid.cols-4{grid-template-columns:1fr;gap:10px}
      .grid.cols-2{grid-template-columns:1fr;gap:10px}
      .title{font-size:20px;gap:8px}
      .title svg{width:24px;height:24px}
      .subtitle{font-size:13px;margin:4px 0 12px}
      .card{padding:14px;border-radius:12px}
      .kpi .value{font-size:24px}
      .kpi .unit{font-size:13px}
      .row{flex-wrap:wrap}
      .btn{width:100%;min-height:48px;font-size:15px}
      input[type="number"],input[type="text"]{padding:10px;font-size:15px}
      label{font-size:11px}
      .pill{font-size:11px;padding:4px 8px}
      .note{font-size:11px}
      
      /* 结果显示优化 */
      #resultsDisplay{gap:24px;padding:24px 16px}
      .result-number{font-size:56px !important}
      .result-unit{font-size:20px !important}
      .result-label{font-size:12px !important}
    }

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important;animation:none !important;scroll-behavior:auto !important}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title" style="gap:10px">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.32L12 14.77 7.22 16.7l.91-5.32L4.27 7.62l5.34-.78L12 2z" fill="url(#g)"/>
        <defs><linearGradient id="g" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse"><stop stop-color="#8ef6d2"/><stop offset="1" stop-color="#6ea8fe"/></linearGradient></defs>
      </svg>
      3DLab 工时 → 打印额度 动态计算器 <span class="pill">根据当学期自动调整</span>
    </div>
    <div class="subtitle">输入售卖、预算比例、耗材单价与本学期总工时，自动得到每小时可兑换克重 R，并按成员工时实时计算可兑换克重与耗材价值（结果<strong>向上取整</strong>）。</div>

    <!-- 输入与结果 -->
    <div class="card" aria-label="全局参数">
      <div class="grid cols-4">
        <div>
          <label for="S">售卖总额 S（元）</label>
          <input id="S" type="number" min="0" step="1" value="600" />
        </div>
        <div>
          <label for="p">打印预算比例 p（0~1）</label>
          <input id="p" type="number" min="0" max="1" step="0.01" value="0.5" />
        </div>
        <div>
          <label for="c">耗材单价 c（元/克）</label>
          <input id="c" type="number" min="0" step="0.001" value="0.045" />
        </div>
        <div>
          <label for="H">总工时 H（小时，所有成员合计）</label>
          <input id="H" type="number" min="1" step="1" value="150" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <div class="kpi" title="每小时可兑换打印克重 R = S &times; p ÷ (c &times; H)">
          <span class="value" id="R">—</span>
          <span class="unit">g/小时</span>
        </div>
        <div class="note">公式：<b>R = S &times; p ÷ (c &times; H)</b>；显示为向上取整（例如 1.333 → 2）。</div>
      </div>
    </div>

    <!-- 兑换额度计算器 -->
    <div class="card grow" aria-label="兑换额度计算" style="display:flex;flex-direction:column;min-height:0">
      <div style="margin-bottom:16px">
        <div class="kpi" style="margin-bottom:12px"><span class="unit" style="font-size:16px;font-weight:600">输入工时，自动计算兑换额度</span></div>
        <div class="grid cols-2">
          <div>
            <label for="name">成员姓名</label>
            <input id="name" type="text" placeholder="请输入姓名" />
          </div>
          <div>
            <label for="hours">工时（小时）</label>
            <input id="hours" type="number" inputmode="decimal" min="0" step="0.1" placeholder="请输入工时" />
          </div>
        </div>
      </div>

      <div id="resultsDisplay" style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:32px;padding:40px 20px">
        <div style="text-align:center">
          <div class="note result-label" style="margin-bottom:12px;font-size:14px">可兑换克重</div>
          <div class="kpi" style="justify-content:center">
            <span class="value result-number" id="resultGrams" style="font-size:48px;color:#8ef6d2">—</span>
            <span class="unit result-unit" style="font-size:24px">g</span>
          </div>
        </div>
        
        <div style="text-align:center">
          <div class="note result-label" style="margin-bottom:12px;font-size:14px">对应耗材价值</div>
          <div class="kpi" style="justify-content:center">
            <span class="value result-number" id="resultValue" style="font-size:48px;color:#6ea8fe">—</span>
            <span class="unit result-unit" style="font-size:24px">元</span>
          </div>
        </div>
      </div>

      <div style="margin-top:auto">
        <button class="btn" id="submitBtn" type="button" onclick="submitData()" style="width:100%;padding:14px;font-size:16px">上传到维格表</button>
        <div class="note" style="margin-top:12px;text-align:center">公式：克重 = ceil(工时 &times; R)；价值 = ceil(克重 &times; c)</div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const S=$('S'), p=$('p'), c=$('c'), H=$('H'), R=$('R');
    const nameInput=$('name'), hoursInput=$('hours');
    const resultGrams=$('resultGrams'), resultValue=$('resultValue');

    function fmtMoney(n){
      if(isNaN(n)) return '—';
      return new Intl.NumberFormat('zh-CN',{minimumFractionDigits:0, maximumFractionDigits:0}).format(n);
    }

    // ---- 纯前端 localStorage 持久化 ----
    let state = null;

    function debounce(fn, delay=300){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    }

    function defaultState(){
      return {
        S: 600,
        p: 0.5,
        c: 0.045,
        H: 150
      };
    }

    function loadState(){
      try{
        const saved = localStorage.getItem('3dlab_state');
        if(saved){
          state = JSON.parse(saved);
        }else{
          state = defaultState();
          saveState();
        }
      }catch(e){
        state = defaultState();
        saveState();
      }
    }

    function saveState(){
      try{
        localStorage.setItem('3dlab_state', JSON.stringify(state));
      }catch(e){
        console.error('保存失败', e);
      }
    }

    function computeR(){
      const Sv = parseFloat(state.S)||0;
      const pv = parseFloat(state.p)||0;
      const cv = parseFloat(state.c)||0.000001;
      const Hv = parseFloat(state.H)||1;
      const r = (Sv*pv)/(cv*Hv);
      return Math.ceil(r);
    }

    function computeForHours(hours){
      const cv = parseFloat(state.c)||0.000001;
      const rCeil = computeR();
      const g = Math.ceil(hours * rCeil);
      const v = Math.ceil(g * cv);
      return {g, v};
    }

    function setInputsFromState(){
      S.value = state.S;
      p.value = state.p;
      c.value = state.c;
      H.value = state.H;
    }

    function updateDisplay(){
      // 更新 R 值
      const rCeil = computeR();
      R.textContent = isFinite(rCeil) ? fmtMoney(rCeil) : '—';
      
      // 更新兑换额度显示
      updateResults();
    }

    function updateResults(){
      const hours = parseFloat(hoursInput.value)||0;
      if(hours <= 0){
        resultGrams.textContent = '—';
        resultValue.textContent = '—';
        return;
      }
      
      const result = computeForHours(hours);
      resultGrams.textContent = fmtMoney(result.g);
      resultValue.textContent = fmtMoney(result.v);
    }

    const updateGlobals = debounce(function(){
      const payload = {
        S: parseFloat(S.value)||0,
        p: parseFloat(p.value)||0,
        c: parseFloat(c.value)||0,
        H: parseFloat(H.value)||1,
      };
      Object.assign(state, payload);
      saveState();
      updateDisplay();
    }, 300);

    function bindInputs(){
      // 全局参数输入
      for (const el of [S,p,c,H]) el.addEventListener('input', updateGlobals);
      
      // 工时输入实时计算
      hoursInput.addEventListener('input', updateResults);
    }

    function main(){
      bindInputs();
      loadState();
      setInputsFromState();
      updateDisplay();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ()=>{ main(); });
    } else {
      main();
    }

    // ---- Vika 维格表同步 ----
    const VIKA_ENDPOINT = 'https://api.vika.cn/fusion/v1/datasheets/dstpAGYsk4vZ2NF0wD/records';
    const VIKA_TOKEN = 'uskCMqxG2JOWhhyYANlan34';

    async function uploadToVika(name, hours, grams, value){
      try{
        // 生成时间戳
        const now = new Date();
        const timestamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        // 构建符合 Vika API 规范的 payload
        const payload = {
          records: [
            {
              fields: {
                "姓名": name,
                "工作时长": hours,
                "料材克重": grams,
                "耗材价值": value,
                "时间": timestamp
              }
            }
          ]
        };

        console.log('Vika 上传 URL:', VIKA_ENDPOINT);
        console.log('Vika 上传数据:', JSON.stringify(payload, null, 2));

        const response = await fetch(VIKA_ENDPOINT, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${VIKA_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        console.log('Vika 响应状态:', response.status, response.statusText);

        if(!response.ok){
          const errorText = await response.text();
          console.error('Vika API 错误响应:', errorText);
          try{
            const errorJson = JSON.parse(errorText);
            console.error('Vika 错误详情:', errorJson);
            alert(`上传失败: ${errorJson.message || errorJson.error || '未知错误'}\n请检查字段名是否与维格表一致`);
          }catch(e){
            alert(`上传失败 (HTTP ${response.status}): ${errorText}`);
          }
          return false;
        }

        const result = await response.json();
        console.log('Vika 上传成功:', result);
        return true;
      }catch(e){
        console.error('上传到 Vika 失败:', e);
        alert(`网络错误: ${e.message}`);
        return false;
      }
    }

    // ---- 上传到维格表 ----
    async function submitData(){
      const btn = document.getElementById('submitBtn');
      const name = nameInput.value.trim();
      const hours = parseFloat(hoursInput.value)||0;

      if(!name){
        alert('请输入姓名');
        return;
      }

      if(hours <= 0){
        alert('请输入有效工时');
        return;
      }

      if(btn){ btn.disabled = true; btn.textContent = '上传中…'; }

      // 计算克重和价值
      const result = computeForHours(hours);
      
      // 上传到 Vika 维格表
      const success = await uploadToVika(name, hours, result.g, result.v);

      if(success){
        alert('✅ 已成功同步至维格表！');
        // 清空输入
        nameInput.value = '';
        hoursInput.value = '';
        resultGrams.textContent = '—';
        resultValue.textContent = '—';
      }else{
        alert('❌ 上传失败，请检查网络或稍后重试');
      }
      
      if(btn){ btn.disabled = false; btn.textContent = '上传到维格表'; }
    }

    window.submitData = submitData;
  </script>
</body>
</html>
