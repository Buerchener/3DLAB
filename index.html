<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>3DLab 工时→打印额度 动态计算器</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b1020;--card:#121830;--muted:#98a2b3;--fg:#e6e9f2;--acc:#6ea8fe;--acc2:#8ef6d2;--warn:#ffd166;
      --ring:#2a345e;--ring-acc:#3d64b3;--surface:#0f1530;--surface-2:#0c1128
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#1b2347 0%,#0b1020 40%,#0b1020 100%);color:var(--fg);font-family:"Noto Sans SC","Microsoft YaHei",-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB",sans-serif;line-height:1.6;min-height:100%;display:flex;flex-direction:column;padding-bottom:max(16px, env(safe-area-inset-bottom))}
    body::before{content:"";position:fixed;inset:0;background:
      radial-gradient(800px 400px at 90% -20%,rgba(110,168,254,.08),transparent 60%),
      radial-gradient(600px 400px at -10% 120%,rgba(142,246,210,.06),transparent 60%);
      pointer-events:none;z-index:-1;filter:blur(0.5px)
    }
    .container{max-width:1080px;margin:24px auto;padding:16px;display:flex;flex-direction:column;flex:1;min-height:0}
    .title{font-weight:800;font-size:28px;letter-spacing:.3px;display:flex;gap:12px;align-items:center}
    .subtitle{color:var(--muted);margin:6px 0 18px}
    .card{background:linear-gradient(180deg,#151c37,#101631);border:1px solid #263159;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.35);padding:18px;transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 14px 40px rgba(0,0,0,.45);border-color:#2e3a6b}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="number"],input[type="text"]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--ring);background:linear-gradient(180deg,var(--surface),var(--surface-2));color:var(--fg);outline:none;transition:border-color .2s ease, box-shadow .2s ease, background .2s ease}
    input:hover{border-color:#334078}
    input:focus{border-color:var(--acc);box-shadow:0 0 0 4px rgba(110,168,254,.18)}
    ::placeholder{color:#6b7280}
    .kpi{display:flex;align-items:baseline;gap:8px;flex-wrap:nowrap}
    .kpi .value{font-weight:800;font-size:32px;color:var(--fg);white-space:nowrap}
    .kpi .unit{color:var(--muted);white-space:nowrap}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--acc),#8aa8ff);color:#0a1022;box-shadow:0 6px 16px rgba(64,87,167,.35);transition:transform .12s ease, box-shadow .12s ease, filter .12s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(64,87,167,.5)}
    .btn:active{transform:translateY(0)}
    .btn.secondary{background:transparent;color:var(--fg);border:1px solid #2a345e}
    .btn.secondary:hover{border-color:#3a4a86;background:rgba(58,74,134,.12)}
    .btn.warn{background:linear-gradient(90deg,var(--warn),#ffc857);color:#382800}
    .btn.warn:hover{filter:brightness(1.02)}
    .row{display:flex;gap:10px;align-items:center}
    .flex-spacer{height:16px}
    .grow{flex:1;min-height:0}
    .table-wrap{height:100%;overflow:auto;border-radius:12px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#141b35,#111733);backdrop-filter:saturate(1.1) blur(2px);font-size:12px;color:var(--muted);text-align:left;padding:8px 12px;border-bottom:1px solid #263159;z-index:1}
    tbody td{background:#0f1530;border:1px solid #263159;padding:12px;border-left:none;border-right:none;transition:background .15s ease,border-color .15s ease}
    tbody tr{border-radius:12px;overflow:hidden}
    tbody td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px;border-left:1px solid #263159}
    tbody td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px;border-right:1px solid #263159}
    tbody tr:hover td{background:#111943;border-color:#2b3a6a}
    tbody tr:nth-child(odd) td{background:#0e1536}
    .note{color:var(--muted);font-size:12px;line-height:1.5}
    .pill{display:inline-block;background:linear-gradient(90deg,rgba(142,246,210,.14),rgba(110,168,254,.12));color:var(--acc2);border:1px solid rgba(142,246,210,.35);padding:6px 10px;border-radius:999px;font-size:12px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    tbody tr{animation:fadeIn .22s ease both}

    /* 响应式 */
    @media (max-width: 900px){
      .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 600px){
      .grid.cols-4{grid-template-columns:1fr}
      .title{font-size:22px}
      .kpi .value{font-size:26px}
      .row{flex-wrap:wrap}
      .btn{width:100%;min-height:44px}
      .btn.secondary{order:2}
      .btn + .btn{margin-left:0;margin-top:8px}
      .table-wrap{border-radius:12px}
      thead{display:none}
      table{border-spacing:0 12px}
      tbody td{display:block;width:100%;font-size:15px;border-left:1px solid #263159;border-right:1px solid #263159}
      tbody td:first-child{border-bottom-left-radius:0;border-top-right-radius:12px}
      tbody td:last-child{border-top-right-radius:0;border-bottom-left-radius:12px}
      tbody tr{position:relative;padding-top:8px}
      tbody tr td[data-k="g"]::before{content:"可兑换克重";display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
      tbody tr td[data-k="v"]::before{content:"对应耗材价值";display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
      tbody tr td:nth-child(1) input{width:100%}
      tbody tr td:nth-child(2) input{width:100%}
      tbody tr td:last-child{display:flex;justify-content:flex-end}
    }

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important;animation:none !important;scroll-behavior:auto !important}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title" style="gap:10px">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.32L12 14.77 7.22 16.7l.91-5.32L4.27 7.62l5.34-.78L12 2z" fill="url(#g)"/>
        <defs><linearGradient id="g" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse"><stop stop-color="#8ef6d2"/><stop offset="1" stop-color="#6ea8fe"/></linearGradient></defs>
      </svg>
      3DLab 工时 → 打印额度 动态计算器 <span class="pill">根据当学期自动调整</span>
    </div>
    <div class="subtitle">输入售卖、预算比例、耗材单价与本学期总工时，自动得到每小时可兑换克重 R，并按成员工时实时计算可兑换克重与耗材价值（结果<strong>向上取整</strong>）。</div>

    <!-- 输入与结果 -->
    <div class="card" aria-label="全局参数">
      <div class="grid cols-4">
        <div>
          <label for="S">售卖总额 S（元）</label>
          <input id="S" type="number" min="0" step="1" value="600" />
        </div>
        <div>
          <label for="p">打印预算比例 p（0~1）</label>
          <input id="p" type="number" min="0" max="1" step="0.01" value="0.5" />
        </div>
        <div>
          <label for="c">耗材单价 c（元/克）</label>
          <input id="c" type="number" min="0" step="0.001" value="0.045" />
        </div>
        <div>
          <label for="H">总工时 H（小时，所有成员合计）</label>
          <input id="H" type="number" min="1" step="1" value="150" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <div class="kpi" title="每小时可兑换打印克重 R = S &times; p ÷ (c &times; H)">
          <span class="value" id="R">—</span>
          <span class="unit">g/小时</span>
        </div>
        <div class="note">公式：<b>R = S &times; p ÷ (c &times; H)</b>；显示为向上取整（例如 1.333 → 2）。</div>
      </div>
    </div>

    <!-- 成员列表 -->
    <div class="card grow" aria-label="成员兑换列表" style="display:flex;flex-direction:column;min-height:0">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap">
        <div class="kpi" style="min-width:200px"><span class="unit">输入成员工时，自动计算兑换额度</span></div>
        <div class="row" style="gap:8px;flex:1;justify-content:flex-end;flex-wrap:wrap">
          <input id="name" type="text" placeholder="姓名" style="max-width:180px;flex:1;min-width:120px" />
          <input id="hours" type="number" inputmode="decimal" min="0" step="0.1" placeholder="工时" style="max-width:140px;flex:1;min-width:100px" />
          <button class="btn" id="submitBtn" type="button" onclick="submitData()">更改</button>
        </div>
      </div>

      <div class="table-wrap" style="flex:1;min-height:0">
        <table>
          <thead>
            <tr>
              <th style="width:28%">成员姓名</th>
              <th style="width:18%">工时（小时）</th>
              <th style="width:22%">可兑换克重（g）</th>
              <th style="width:22%">对应耗材价值（元）</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- 动态行 -->
          </tbody>
        </table>
      </div>
      <div class="note" style="margin-top:8px">说明：克重 = ceil(工时 &times; R)；价值 = ceil(克重 &times; c)。
        c 为每克耗材价格，例：45 元/卷（1kg） → 0.045 元/克。
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const S=$('S'), p=$('p'), c=$('c'), H=$('H'), R=$('R'), tbody=$('tbody');

    function fmtMoney(n){
      if(isNaN(n)) return '—';
      return new Intl.NumberFormat('zh-CN',{minimumFractionDigits:0, maximumFractionDigits:0}).format(n);
    }

    // ---- 纯前端 localStorage 持久化 ----
    let state = null;

    function debounce(fn, delay=300){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    }

    function defaultState(){
      return {
        S: 600,
        p: 0.5,
        c: 0.045,
        H: 150,
        nextId: 4,
        members: [
          {id:1, name:"张三", hours:5},
          {id:2, name:"李四", hours:8},
          {id:3, name:"王五", hours:10}
        ]
      };
    }

    function loadState(){
      try{
        const saved = localStorage.getItem('3dlab_state');
        if(saved){
          state = JSON.parse(saved);
        }else{
          state = defaultState();
          saveState();
        }
      }catch(e){
        state = defaultState();
        saveState();
      }
    }

    function saveState(){
      try{
        localStorage.setItem('3dlab_state', JSON.stringify(state));
      }catch(e){
        console.error('保存失败', e);
      }
    }

    function computeResponse(){
      const Sv = parseFloat(state.S)||0;
      const pv = parseFloat(state.p)||0;
      const cv = parseFloat(state.c)||0.000001;
      const Hv = parseFloat(state.H)||1;
      const r = (Sv*pv)/(cv*Hv);
      const rCeil = Math.ceil(r);
      
      const members = (state.members||[]).map(m=>{
        const hours = parseFloat(m.hours)||0;
        const g = Math.ceil(hours * rCeil);
        const v = Math.ceil(g * cv);
        return {
          id: m.id,
          name: m.name||'',
          hours,
          g,
          v
        };
      });

      return {
        S: Sv,
        p: pv,
        c: cv,
        H: Hv,
        R: rCeil,
        members
      };
    }

    function setInputsFromState(){
      S.value = state.S;
      p.value = state.p;
      c.value = state.c;
      H.value = state.H;
    }

    function renderAll(){
      const computed = computeResponse();
      // KPI R
      R.textContent = isFinite(computed.R) ? fmtMoney(computed.R) : '—';
      // 表格
      tbody.innerHTML = (computed.members||[]).map(m=>`
        <tr data-id="${m.id}">
          <td><input type="text" placeholder="姓名" data-k="name" value="${m.name||''}"/></td>
          <td><input type="number" inputmode="decimal" min="0" step="1" data-k="h" value="${m.hours||0}"/></td>
          <td data-k="g">${isFinite(m.g)? fmtMoney(m.g): '—'}</td>
          <td data-k="v">${isFinite(m.v)? fmtMoney(m.v): '—'}</td>
          <td><button class="btn warn" type="button" data-action="del">删除</button></td>
        </tr>
      `).join('');

      // 行事件绑定
      for(const tr of tbody.querySelectorAll('tr')){
        const id = Number(tr.getAttribute('data-id'));
        const nameInput = tr.querySelector('input[data-k="name"]');
        const hoursInput = tr.querySelector('input[data-k="h"]');
        const delBtn = tr.querySelector('button[data-action="del"]');

        nameInput.addEventListener('change', ()=>{
          const member = state.members.find(m=>m.id===id);
          if(member){
            member.name = nameInput.value.trim();
            saveState();
            renderAll();
          }
        });

        const updateHours = debounce(()=>{
          const hours = parseFloat(hoursInput.value)||0;
          const member = state.members.find(m=>m.id===id);
          if(member){
            member.hours = hours;
            saveState();
            renderAll();
          }
        }, 300);
        hoursInput.addEventListener('input', updateHours);

        if (delBtn){
          delBtn.addEventListener('click', ()=>{
            state.members = state.members.filter(m=>m.id!==id);
            saveState();
            renderAll();
          });
        }
      }
    }

    const updateGlobals = debounce(function(){
      const payload = {
        S: parseFloat(S.value)||0,
        p: parseFloat(p.value)||0,
        c: parseFloat(c.value)||0,
        H: parseFloat(H.value)||1,
      };
      Object.assign(state, payload);
      saveState();
      renderAll();
    }, 300);

    function bindGlobalInputs(){
      for (const el of [S,p,c,H]) el.addEventListener('input', updateGlobals);
    }

    function main(){
      bindGlobalInputs();
      loadState();
      setInputsFromState();
      renderAll();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ()=>{ main(); });
    } else {
      main();
    }

    // ---- 更改成员 ----
    function submitData(){
      const btn = document.querySelector('button[onclick="submitData()"]');
      const nameEl = document.getElementById('name');
      const hoursEl = document.getElementById('hours');
      const name = (nameEl && nameEl.value ? nameEl.value : '').trim();
      const hoursValue = hoursEl && hoursEl.value !== undefined ? parseFloat(hoursEl.value) : 0;
      const hours = isNaN(hoursValue) ? 0 : hoursValue;

      if(!name){
        alert('请输入姓名');
        return;
      }

      // 查找同名成员，存在则覆盖工时，不存在则新增
      const existing = state.members.find(m=>m.name.trim()===name);
      if(existing){
        existing.hours = hours;
      }else{
        const nextId = Math.max(...state.members.map(m=>m.id||0), 0) + 1;
        state.members.push({id:nextId, name, hours});
      }
      saveState();
      renderAll();
      alert('✅ 已在网页中更新！');
      
      // 清空输入
      if(nameEl) nameEl.value = '';
      if(hoursEl) hoursEl.value = '';
    }

    window.submitData = submitData;
  </script>
</body>
</html>
